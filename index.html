<html>
<body>
<pre id='log'></pre>
<button id='ping'>ping</button>
<script>
  let RTCPeerConnection = window.RTCPeerConnection || window.webkitRTCPeerConnection
  let config = {"iceServers": [{"url": "stun:stun.l.google.com:19302"}]}
  let pc = new RTCPeerConnection(config)
  let dc = pc.createDataChannel('test')
  let log = document.querySelector('#log')
  let btn = document.querySelector('#ping')

  btn.onclick = () => {
    dc.send('ping')
  }

  dc.onopen = () => {
    console.log('data channel open')
  }

  dc.onmessage = e => {
    console.log(e)
  }

  pc.onicecandidate = event => {
    if(!event.candidate) return

    fetch('http://localhost:8081/ice-candidate', {
      method: 'POST',
      headers: {
        'content-type': 'application/json'
      },
      body: JSON.stringify(event.candidate)
    })
  }

  pc.createOffer().then(offer => {
    pc.setLocalDescription(offer)

    fetch('http://localhost:8081/offer', {
      method: 'POST',
      headers: {
        'content-type': 'application/json'
      },
      body: JSON.stringify(offer)
    }).then(res => res.json())
      .then(answer => pc.setRemoteDescription(new RTCSessionDescription(answer)))
      .then(out => console.log(pc))
  })
</script>
</body>
</html>
